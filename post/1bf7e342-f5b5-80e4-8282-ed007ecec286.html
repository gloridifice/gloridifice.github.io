<!DOCTYPE html><html>
  <head>
    <meta name="darkreader-lock" content="true">
    <meta http-equiv="Content-Type" content="charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/assets/js/header.js"></script>
    <script src="/assets/katex/katex.js"></script>
<script defer src="/assets/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>    <script>document.addEventListener(&quot;DOMContentLoaded&quot;, function() {
    renderMathInElement(document.body, {
      delimiters: [
          {left: '$$', right: '$$', display: false},
      ],
      throwOnError : false
    });
});</script>
    <link rel="stylesheet" href="/assets/katex/katex.css">
    <link rel="stylesheet" href="/assets/css/reset.css">
    <link rel="stylesheet" href="/assets/css/root.css">
    <link rel="stylesheet" href="/assets/css/color_scheme_v2.dark_mode.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600;700&amp;display=swap" rel="stylesheet">
    <script src="/assets/js/highlightjs/highlight.js"></script>
    <link rel="stylesheet" href="/assets/css/layout.css">
    <link rel="stylesheet" href="/assets/css/page_content.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/color_scheme_v2.dark_mode.css">
    <link rel="stylesheet" href="/assets/css/highlightjs/github-dark.css">
    <title>ğŸ” ä½¿ç”¨ Bevy åå°„åºåˆ—åŒ–ç»„ä»¶ </title>
  </head>
  <body>
    <script>hljs.highlightAll();</script>
    <div class="post">
      <div class="catalogue">
        <div>
          <ul>
            <li class="h1"><a href="#heading1_0">
                <t class="">(å/)åºåˆ—åŒ– Entity çš„æ‰€æœ‰ Component</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t class="">è·å¾— Entity çš„ Component ä¿¡æ¯</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t class="">åºåˆ—åŒ–åå°„</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t class="">ååºåˆ—åŒ–åå°„</t>
              </a></li>
            <li class="h1"><a href="#heading1_1">
                <t class="">æ’å…¥åå°„ç»„ä»¶åˆ°å®ä½“ä¸­</t>
              </a></li>
            <li class="h1"><a href="#heading1_2">
                <t class="">è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹æ˜¯å¦å®ç°äº†æŸä¸ª trait</t>
              </a></li>
          </ul>
        </div>
      </div>
      <div class="navi"><a class="navi_link" href="/home.html">ä¸»é¡µ</a><a class="navi_link" href="/blogs.html">åšå®¢</a><a class="navi_link" href="/portfolio.html">é¡¹ç›®</a><a class="navi_link" href="/about.html">å…³äº</a></div>
      <div class="sidebar_wrapper_left sidebar_wrapper"></div>
      <div class="sidebar_wrapper_right sidebar_wrapper"></div>
      <div class="contents">
        <div class="header"><a class="navi_link" href="/home.html">ä¸»é¡µ</a><a class="navi_link" href="/blogs.html">åšå®¢</a><a class="navi_link" href="/portfolio.html">é¡¹ç›®</a><a class="navi_link" href="/about.html">å…³äº</a></div>
        <div class="page_description">
          <h1 class="title">ğŸ” ä½¿ç”¨ Bevy åå°„åºåˆ—åŒ–ç»„ä»¶ </h1>
          <div class="sub_info">
            <p class="date">2025-06-05</p>
            <div class="type_tags">
              <p class="tag">Bevy</p>
              <p class="tag">Rust</p>
              <p class="tag">Game Dev</p>
              <p class="tag">Serialization</p>
              <p class="type">Dev</p>
            </div>
          </div>
        </div>
        <div class="page_content">
          <h1 id="heading1_0">
            <t class="">(å/)åºåˆ—åŒ– Entity çš„æ‰€æœ‰ Component</t>
          </h1>
          <p>
            <t class="">åªæ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œæœ¬æ–‡åœ¨ä¸€ä¸ª test æ¥å­¦ä¹ å’Œæµ‹è¯• reflect åŠŸèƒ½ã€‚æ–¹ä¾¿æµ‹è¯•å’Œæ‰“å°ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[cfg(test)]
mod test {
  fn test_reflect() {
    todo!();
  }
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h2 id="heading2_0">
            <t class="">è·å¾— Entity çš„ Component ä¿¡æ¯</t>
          </h2>
          <p>
            <t class="">åå°„çš„ç±»å‹ä¿¡æ¯ç”± </t>
            <t class="code">TypeRegistry</t>
            <t class=""> ç®¡ç†ã€‚æˆ‘ä»¬çš„ App ç±»å‹æ³¨å†Œä¿¡æ¯å­˜å‚¨åœ¨ </t>
            <t class="code">AppTypeRegistry</t>
            <t class=""> ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ª</t>
<a class="link" href="https://doc.rust-lang.org/beta/std/sync/struct.RwLock.html">è¯»å†™é”</a>
            <t class="">ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥å£°æ˜ä¸€ä¸ªç±»å‹ </t>
            <t class="code">Foo</t>
            <t class="">ï¼Œç„¶åæ³¨å†Œå®ƒä¸ºä¾‹ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[cfg(test)]
mod test {
  #[derive(Reflect, Component)]
  struct Foo {
    a: f32
    b: i32
  }
  fn test_reflect() {
      let mut app = App::new();
      app.register_type::&lt;Foo&gt;();
      
      let world = app.world_mut();
      
      let registry_arc: TypeRegistryArc = world.resource::&lt;AppTypeRegistry&gt;().0.clone();
      let registry = registry_arc.read();
      
      todo!();
  }
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <ul>
            <li>
              <t class="code">AppTypeRegistry # 0</t>
              <t class=""> æ˜¯ä¸€ä¸ªåŸå­å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…‹éš†å®ƒæ¥é¿å…å ç”¨ä¸–ç•Œçš„æ‰€æœ‰æƒ</t>
            </li>
          </ul>
          <blockquote>
            <t class="">æˆ‘ä»¬å£°æ˜ä¸€ä¸ª App æ˜¯ä¸ºäº†åç»­ </t>
            <t class="code">Component</t>
            <t class=""> çš„æµ‹è¯•ã€‚å¦‚æœåªæƒ³æµ‹è¯•åå°„ï¼Œä¸éœ€è¦ç”¨åˆ° </t>
            <t class="code">World</t>
            <t class="">ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ„é€ å‡½æ•°å®ä¾‹åŒ–ä¸€ä¸ª </t>
            <t class="code">TypeRegistry</t>
            <t class=""> ã€‚å¦‚ï¼š
- </t>
            <t class="code">let registry = TypeRegistry::new();</t>
          </blockquote>
          <p>
            <t class="">æ¥ç€ï¼Œè¦æƒ³è·å¾—ä¸€ä¸ª Entity çš„æ‰€æœ‰ Component çš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ </t>
            <t class="code">World # inspect_entity</t>
            <t class="">ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª </t>
            <t class="code">&amp;ComponentInfo</t>
            <t class=""> çš„è¿­ä»£å™¨ã€‚æ³¨æ„ï¼Œå¦‚æœ Entity ä¸å­˜åœ¨ï¼Œ</t>
            <t class="code">inspect_entity</t>
            <t class=""> ä¼šç›´æ¥ panic. åœ¨å®é™…ä½¿ç”¨å‰æœ€å¥½æ£€æŸ¥ä¸€ä¸‹ Entity æ˜¯å¦è¿˜å­˜åœ¨ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">// test_reflect()
let id = world.spawn(Foo { a: 0, b: 0 });
if world.entities().contains(id) { // æ£€æŸ¥å®ä½“å­˜åœ¨
  for component_info in world.inspect_entity(id) {
    todo!();
  }
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h2 id="heading2_1">
            <t class="">åºåˆ—åŒ–åå°„</t>
          </h2>
          <p>
            <t class="">æ¥ç€æˆ‘ä»¬é€šè¿‡ </t>
            <t class="code">World # get_reflect</t>
            <t class="">è·å¾—æŸä¸ªå®ä½“çš„æŸä¸ªç»„ä»¶çš„åå°„ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">// åœ¨ for loop ä¸­
let component_reflect: &amp;dyn Reflect = world.get_reflect(id, component_info.type_id().unwrap()).unwrap();

let serialzier =
    ReflectSerializer::new(component_reflect.as_partial_reflect(), &amp;registry);
let str = toml::to_string_pretty(&amp;serialzier).unwrap();
println!(&quot;{}&quot;, &amp;str); // Debug</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <ul>
            <li>
              <t class="code">ReflectSerializer</t>
              <t class=""> åå°„å†…å®¹çš„åºåˆ—åŒ–å™¨ï¼Œå¯ä»¥è¢«å„ç±»åŸºäº serde çš„åºåˆ—åŒ–æ–¹æ³•åºåˆ—åŒ–</t>
            </li>
          </ul>
          <ul>
            <li>
              <t class="">åœ¨ toml ä¸­ï¼Œåå°„çš„ </t>
              <t class="code">Foo</t>
              <t class=""> çš„åºåˆ—åŒ–çš„ç»“æœæ˜¯ä¸€ä¸ª </t>
              <t class="code">toml::Table</t>
              <t class=""> é‡ŒåŒ…å«äº†ä¸€ä¸ªé”®å€¼ï¼Œå…¶é”®æ˜¯ </t>
              <t class="code">Foo</t>
              <t class=""> çš„ç±»å‹è·¯å¾„ï¼Œå€¼è¿˜æ˜¯ä¸€ä¸ª </t>
              <t class="code">Table</t>
              <t class="">ï¼ŒåŒ…å«äº† </t>
              <t class="code">Foo</t>
              <t class=""> çš„å­—æ®µã€‚</t>
            </li>
          </ul>
          <h2 id="heading2_2">
            <t class="">ååºåˆ—åŒ–åå°„</t>
          </h2>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">// è¿™æ˜¯ toml æ ¼å¼çš„ Table
let table = toml::from_str::&lt;toml::Table&gt;(&amp;str).unwrap();
let key = table.iter().last().unzip().0.unwrap().clone();

// é‡è¦çš„åœ°æ–¹ï¼
let reflect_deserializer = ReflectDeserializer::new(&amp;registry);
let partial_reflect: Box&lt;dyn PartialReflect&gt; =
    reflect_deserializer.deserialize(table).unwrap();
    
assert!(partial_reflect.represents::&lt;Foo&gt;()); // æ£€æŸ¥éƒ¨åˆ†åå°„ä»£è¡¨çš„æ˜¯å¦æ˜¯ç±»å‹ Foo</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <ul>
            <li>
              <t class="code">key</t>
              <t class="">ï¼šè¿™é‡Œè·å¾—çš„ key æ˜¯ </t>
              <t class="code">Foo</t>
              <t class=""> çš„å®Œæ•´ç±»å‹è·¯å¾„ã€‚åé¢æ’å…¥ Component æ—¶ä¼šç”¨åˆ°ã€‚</t>
            </li>
          </ul>
          <ul>
            <li>
              <t class="code">ReflectDeserializer</t>
              <t class="">ï¼šååºåˆ—åŒ–å™¨ï¼Œå…¶ </t>
              <t class="code"># deserialize</t>
              <t class=""> æ–¹æ³•æ¥è‡ªå¯¹ serde çš„ </t>
              <t class="code">DeserializeSeed</t>
              <t class=""> trait å®ç°ï¼Œå¦‚æœ rust analyzer æ— æ³•æ‰¾åˆ° </t>
              <t class="code"># deserialize</t>
              <t class=""> æ–¹æ³•ï¼Œéœ€è¦æ‰‹åŠ¨ </t>
              <t class="code">use DeserializeSeed</t>
              <t class=""> .</t>
            </li>
          </ul>
          <p></p>
          <h1 id="heading1_1">
            <t class="">æ’å…¥åå°„ç»„ä»¶åˆ°å®ä½“ä¸­</t>
          </h1>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">let type_registration: &amp;TypeRegistration = registry.get_with_type_path(&amp;key).unwrap();
let type_id: TypeId = TypeRegistration::type_id(type_registration);</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <ul>
            <li>
              <t class="code">type_registration</t>
              <t class="">ï¼šæˆ‘ä»¬ä½¿ç”¨ä¸Šé¢å¾—åˆ°çš„ç±»å‹è·¯å¾„ï¼ˆkeyï¼‰è·å–ç±»å‹çš„æ³¨å†Œä¿¡æ¯ï¼Œä¸ºäº†è·å–ç±»å‹çš„ </t>
              <t class="code">TypeId</t>
            </li>
          </ul>
          <ul>
            <li>
              <t class="code">type_id</t>
              <t class="">ï¼šé€šè¿‡ </t>
              <t class="code">TypeRegistration # type_id</t>
              <t class=""> æ¥è·å–æ³¨å†Œç±»å‹çš„ TypeIdï¼Œè¿™é‡Œä½¿ç”¨æ˜¾å¼çš„æ–¹æ³•è°ƒç”¨æ˜¯ä¸ºäº†ä¸æ ‡å‡†åº“åŸæœ‰çš„ </t>
              <t class="code">Any # type_id</t>
              <t class=""> å‡½æ•°åŒºåˆ†ã€‚</t>
            </li>
          </ul>
          <p>
            <t class="">åç»­ä¼šç”¨åˆ°åœ°ï¼Œä¸ºäº†è®©å¯ä»¥ç»„ä»¶çš„åå°„å¯ä»¥æ‰§è¡Œ </t>
            <t class="code">Component</t>
            <t class=""> çš„ trait çš„è¡Œä¸ºï¼Œéœ€è¦ä¸ºæˆ‘ä»¬çš„ </t>
            <t class="code">Foo</t>
            <t class="">  ç±»å‹æ ‡è®° </t>
            <t class="code">reflect</t>
            <t class=""> å®ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[derive(Reflect, Component)]
#[reflect(Component, from_reflect = true)] // new!
struct Foo {
    a: f32,
    b: i32,
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p>
            <t class="">æ¥ç€å¯ä»¥é€šè¿‡ </t>
            <t class="code">get_type_data::&lt;ReflectComponent&gt;</t>
            <t class=""> å°†åå°„ä½œä¸ºç»„ä»¶æ’å…¥å®ä½“ã€‚</t>
<a class="link" href="https://docs.rs/bevy/0.15.3/bevy/ecs/prelude/struct.ReflectComponent.html">ReflectComponent</a>
            <t class=""> å¯ä»¥æ“ä½œå®ç°äº† Component trait çš„ç±»å‹çš„åå°„ã€‚éœ€è¦æˆ‘ä»¬å¯¹ç±»å‹ä½¿ç”¨ </t>
            <t class="code">#[reflect(Component)]</t>
            <t class=""> å®æ‰èƒ½è¢«è®°å½•åˆ° </t>
            <t class="code">TypeRegistry</t>
            <t class=""> ä¸­ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">if let Some(reflect_component) =
    registry.get_type_data::&lt;ReflectComponent&gt;(type_id) // -&gt; Option&lt;&amp;ReflectComponent&gt;
{
    info!(&quot;Successfully insert reflect component!&quot;);
    reflect_component.insert(
        &amp;mut world.entity_mut(id),
        partial_reflect.as_ref(),
        &amp;registry,
    );
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p>
            <t class="">ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ </t>
            <t class="code">TypeRegistration</t>
            <t class=""> æ¥è·å– </t>
            <t class="code">Foo</t>
            <t class=""> ç±»å‹çš„ </t>
            <t class="code">ReflectComponent</t>
            <t class=""> æ•°æ®ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">type_registration.data::&lt;ReflectComponent&gt;(); // -&gt; Option&lt;&amp;ReflectComponent&gt;</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h1 id="heading1_2">
            <t class="">è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹æ˜¯å¦å®ç°äº†æŸä¸ª trait</t>
          </h1>
          <p>
            <t class="">ä¸Šæ–‡ä¸­æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œä¸€ä¸ªç±»å‹çš„ trait æ•°æ®ä»¥ data çš„å½¢å¼å­˜å‚¨åœ¨ </t>
            <t class="code">TypeRegistry</t>
            <t class=""> ä¸­ã€‚å¦‚æœæˆ‘ä»¬æƒ³è®°å½•ç±»å‹å®ç°çš„æˆ‘ä»¬è‡ªå·±çš„ traitï¼Œä¹Ÿå¯ä»¥é€šè¿‡ </t>
            <t class="code">reflect</t>
            <t class=""> å®æ¥å®ç°ã€‚</t>
            <t class="code">reflect</t>
            <t class=""> å®ä¼šè‡ªåŠ¨æ³¨å†Œ trait çš„åå°„æ•°æ®ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[derive(Reflect, Component)]
#[reflect(FooTrait, Component, from_reflect = true)] // new!
struct Foo {
    a: f32,
    b: i32,
}

#[reflect_trait] // new!
trait FooTrait {}

impl FooTrait for Foo {}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p>
            <t class="">æˆ‘ä»¬éœ€è¦ä¸ºæƒ³è¦è¢«è®°å½•åå°„ä¿¡æ¯çš„ </t>
            <t class="code">FooTrait</t>
            <t class=""> æ‰“ä¸Š </t>
            <t class="code">reflect_trait</t>
            <t class=""> å®ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªç»“æ„ä½“å«åš </t>
            <t class="code">ReflectFooTrait</t>
            <t class="">.äºæ­¤åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ </t>
            <t class="code">Foo</t>
            <t class=""> ç±»å‹çš„ </t>
            <t class="code">reflect</t>
            <t class=""> å®ä¸­åŠ ä¸Š </t>
            <t class="code">FooTrait</t>
            <t class=""> .</t>
          </p>
          <ul>
            <li><a class="link" href="https://docs.rs/bevy/latest/bevy/prelude/attr.reflect_trait.html">reflect_trait</a>
              <t class=""> å®ä¼šè‡ªåŠ¨ç”Ÿæˆ trait çš„æ•°æ®ï¼Œæ—¢ </t>
              <t class="code">Reflect{trait_ident}</t>
              <t class=""> ç»“æ„ä½“ã€‚</t>
            </li>
          </ul>
          <p>
            <t class="">ç»è¿‡ä»¥ä¸Šè¡Œä¸ºåï¼Œæˆ‘ä»¬å°±å¯ä»¥åƒè·å– </t>
            <t class="code">ReflectComponent</t>
            <t class=""> ä¸€æ ·è·å– </t>
            <t class="code">ReflectFooTrait</t>
            <t class="">ï¼Œä»¥æ­¤æ¥åˆ¤æ–­ä¸€ä¸ªç±»å‹æ˜¯å¦å®ç°äº†æŸä¸ª trait.</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">let is_impl_foo_trait =
  type_registration.data::&lt;ReflectFooTrait&gt;().is_some();
  // or
  registry.get_type_data::&lt;ReflectComponent&gt;(type_id).is_some();</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p></p>
        </div>
      </div>
    </div>
  </body>
</html>
